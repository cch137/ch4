"use strict";(()=>{let e=e=>JSON.parse(new TextDecoder().decode(e.reverse().map(e=>255&~e))),r=e=>new TextEncoder().encode(JSON.stringify(e)).map(e=>255&~e).reverse(),t=e=>window.dispatchEvent(new Event(`TTX-${e}`)),a=(e,s={})=>{if($.readyState!==$.OPEN){let o=()=>{a(e,s),$.removeEventListener("open",o)};$[n]("open",o);return}t(e),$.send(r({...s,type:e}))},s=()=>{let e=location.href;d=e,a("view",{href:e,focus:f()})},n="addEventListener",o=()=>localStorage.getItem("t")||"",c=e=>localStorage.setItem("t",e),f=()=>document.hasFocus(),d="",$,i=(r=!1)=>{if(!r&&!f()){setTimeout(i,1e3);return}($=new WebSocket(`ws://localhost:4000/3/${o()}`))[n]("open",()=>{let e=setInterval(()=>{if($.readyState!==$.OPEN)return clearInterval(e);d!==location.href?s():$.send(new Uint8Array([0]))},1e3)}),$[n]("message",async r=>{let{cmd:a,...n}=e(new Uint8Array(await r.data.arrayBuffer()));if(console.log(a,n),"string"==typeof a)switch(t(a),a){case"uid":c(n.uid);break;case"conn":s();break;case"v-err":location.reload()}}),$[n]("error",e=>{console.error(e),$.close()}),$[n]("close",()=>{setTimeout(i,1e3)})};window[n]("blur",()=>a("blur")),window[n]("focus",()=>a("focus")),window[n]("TTX-record",({data:{type:e,data:r}})=>a(e,r)),i(!0)})();