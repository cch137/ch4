"use strict";(()=>{let e=e=>JSON.parse(new TextDecoder().decode(e.reverse().map(e=>255&~e))),r=e=>new TextEncoder().encode(JSON.stringify(e)).map(e=>255&~e).reverse(),t=e=>window.dispatchEvent(new Event(`TTX-${e}`)),s=(e,a={})=>{if(i.readyState!==i.OPEN){let o=()=>{s(e,a),i.removeEventListener("open",o)};i[n]("open",o);return}t(e),i.send(r({...a,type:e}))},a=()=>{let e=location.href;d=e,s("view",{href:e,focus:f()})},n="addEventListener",o=()=>localStorage.getItem("t")||"",c=e=>localStorage.setItem("t",e),f=()=>document.hasFocus(),d="",i,$=(r=!1)=>{if(!r&&!f()){setTimeout($,1e3);return}(i=new WebSocket(`wss://space.cch137.link/3/${o()}`))[n]("open",()=>{let e=setInterval(()=>{if(i.readyState!==i.OPEN)return clearInterval(e);d!==location.href?a():i.send(new Uint8Array([0]))},1e3)}),i[n]("message",async r=>{let{cmd:s,...n}=e(new Uint8Array(await r.data.arrayBuffer()));if("string"==typeof s)switch(t(s),s){case"uid":c(n.uid);break;case"conn":a();break;case"v-err":location.reload()}}),i[n]("error",e=>{console.error(e),t("error"),i.close()}),i[n]("close",()=>{setTimeout($,1e3)})};window[n]("blur",()=>s("blur")),window[n]("focus",()=>s("focus")),window[n]("TTX-record",({data:{type:e,data:r}})=>s(e,r)),$(!0)})();